<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TXT é ç«¯è®€å–å™¨ (è‡ªå‹•åµæ¸¬ç·¨ç¢¼ç‰ˆ)</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { color: #1a73e8; margin-top: 0; }
        .input-group { margin: 20px 0; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; outline: none; }
        input[type="text"]:focus { border-color: #1a73e8; }
        button { padding: 10px 25px; background-color: #1a73e8; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #1557b0; }
        #status { margin: 10px 0; font-size: 14px; font-weight: bold; }
        #content { 
            white-space: pre-wrap; 
            background: #1e1e1e; 
            color: #d4d4d4; 
            padding: 15px; 
            border-radius: 6px; 
            min-height: 300px; 
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            overflow-x: auto;
            border: 1px solid #333;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>TXT é ç«¯æ–‡ä»¶è®€å–å™¨</h2>
    <p style="color: #666;">æ”¯æ´è‡ªå‹•åµæ¸¬ UTF-8 / GBK / Big5 ç·¨ç¢¼</p>

    <div class="input-group">
        <input type="text" id="urlInput" placeholder="è«‹è¼¸å…¥ txt ç¶²å€" value="http://alist.hopto.org/cat/BMW/tv2.txt">
        <button onclick="fetchText()">è®€å–å…§å®¹</button>
    </div>

    <div id="status">æº–å‚™å°±ç·’</div>
    <div id="content">ç­‰å¾…è®€å–...</div>
</div>

<script>
    function detectEncoding(arrayBuffer) {
        const encodings = ["utf-8", "gbk", "big5"];
        let bestText = "";
        let bestEncoding = "utf-8";
        let lowestGarbage = Infinity;

        encodings.forEach(enc => {
            try {
                const decoder = new TextDecoder(enc);
                const text = decoder.decode(arrayBuffer);

                // è¨ˆç®—äº‚ç¢¼æ¯”ä¾‹ï¼šéä¸­æ–‡å­—å…ƒéå¤šè¦–ç‚ºäº‚ç¢¼
                const garbageCount = (text.match(/[ ]/g) || []).length;

                if (garbageCount < lowestGarbage) {
                    lowestGarbage = garbageCount;
                    bestText = text;
                    bestEncoding = enc;
                }
            } catch (e) {
                // æŸäº›ç€è¦½å™¨å¯èƒ½ä¸æ”¯æ´ Big5
            }
        });

        return { text: bestText, encoding: bestEncoding };
    }

    async function fetchText() {
        const url = document.getElementById('urlInput').value;
        const contentDiv = document.getElementById('content');
        const statusDiv = document.getElementById('status');

        if (!url) return alert("è«‹è¼¸å…¥ç¶²å€");

        statusDiv.innerText = "ğŸ”„ æ­£åœ¨ç¹éå°é–è®€å–ä¸­...";
        statusDiv.style.color = "#f39c12";
        contentDiv.innerText = "è¼‰å…¥ä¸­...";

        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;

        try {
            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("ä»£ç†ä¼ºæœå™¨é€£ç·šå¤±æ•—");

            const arrayBuffer = await response.arrayBuffer();

            // è‡ªå‹•åµæ¸¬ç·¨ç¢¼
            const result = detectEncoding(arrayBuffer);

            contentDiv.innerText = result.text;
            statusDiv.innerText = `âœ… è®€å–æˆåŠŸï¼è‡ªå‹•åµæ¸¬ç·¨ç¢¼ï¼š${result.encoding}`;
            statusDiv.style.color = "#27ae60";
        } catch (error) {
            console.error(error);
            statusDiv.innerText = "âŒ éŒ¯èª¤: " + error.message;
            statusDiv.style.color = "#e74c3c";
            contentDiv.innerHTML = `
                <div style="color:#ff6b6b">
                    è®€å–å¤±æ•—ï¼é€™é€šå¸¸æœ‰å…©å€‹åŸå› ï¼š<br><br>
                    1. <b>CORS ä»£ç†è¢«é˜»æ“‹</b>ï¼šè«‹å˜—è©¦å®‰è£ Chrome æ“´å……åŠŸèƒ½ ã€ŒAllow CORSã€ä¸¦é–‹å•Ÿå®ƒã€‚<br>
                    2. <b>ä¾†æºç¶²å€ä¸ç©©å®š</b>ï¼šè©²ä¼ºæœå™¨å¯èƒ½æ‹’çµ•äº†ä»£ç†è«‹æ±‚ã€‚
                </div>`;
        }
    }
</script>

</body>
</html>
