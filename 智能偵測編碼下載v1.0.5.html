<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½åµæ¸¬ç·¨ç¢¼è®€å–å™¨ v1.0.5</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --editor-bg: #1e1e1e;
            --primary-color: #1a73e8;
            --text-color: #d4d4d4;
        }

        body, html { 
            margin: 0; padding: 0; height: 100%; overflow: hidden; 
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
        }

        .main-wrapper {
            display: flex; flex-direction: column;
            height: 100vh; padding: 15px; box-sizing: border-box;
        }

        .title-section { margin-bottom: 10px; }
        .title-bar {
            font-size: 24px; font-weight: bold; color: #1a73e8;
            display: flex; align-items: center; gap: 8px; margin-bottom: 2px;
        }
        .strategy-info { font-size: 14px; color: #666; margin-bottom: 10px; }

        .header {
            display: flex; width: 100%; gap: 10px;
            padding-bottom: 15px; align-items: center;
        }

        #urlInput {
            flex-grow: 1; min-width: 0; padding: 10px 15px; 
            border: 1px solid #ccc; border-radius: 4px; 
            font-size: 16px; outline: none;
        }

        .btn-group { display: flex; gap: 8px; flex-shrink: 0; }

        button {
            padding: 10px 20px; background: var(--primary-color); 
            color: white; border: none; border-radius: 4px; 
            cursor: pointer; font-weight: bold; white-space: nowrap;
        }

        button.secondary { background: #5f6368; }
        button:hover { filter: brightness(1.1); }

        .content-area {
            display: flex; flex: 1; gap: 12px; min-height: 0; 
        }

        .log-panel {
            flex: 0 0 350px; 
            display: flex; flex-direction: column;
            background: #fff; border-radius: 8px; border: 1px solid #ddd; overflow: hidden;
        }

        .result-panel {
            flex: 1; 
            display: flex; flex-direction: column;
            background: var(--editor-bg); border-radius: 8px; border: 1px solid #333; overflow: hidden;
        }

        .panel-label {
            padding: 8px 12px; background: #eee; color: #555;
            font-size: 12px; font-weight: bold; border-bottom: 1px solid #ddd;
        }

        .dark-label { background: #333; color: #aaa; border-bottom: 1px solid #444; }

        pre {
            margin: 0; padding: 15px; flex: 1;
            overflow: auto; color: var(--text-color);
            font-family: 'Consolas', monospace; line-height: 1.6; font-size: 14px;
        }

        #logEntries {
            margin: 0; padding: 10px; flex: 1;
            overflow-y: auto; list-style: none; font-size: 13px;
            display: flex; flex-direction: column;
        }

        .log-item { border-bottom: 1px solid #f0f0f0; padding: 5px 0; word-break: break-all; }
        .log-success { color: #2e7d32; font-weight: bold; }
        .log-error { color: #d32f2f; }
    </style>
</head>
<body>

<div class="main-wrapper">
    <div class="title-section">
        <div class="title-bar">ğŸ“„ æ™ºèƒ½åµæ¸¬ç·¨ç¢¼è®€å–å™¨ v1.0.5</div>
        <div class="strategy-info">ç­–ç•¥ï¼šå„ªå…ˆç›´é€£ â” æ¨¡å¼ 1 (CorsProxy) â” æ¨¡å¼ 2 (AllOrigins) â” è‡ªå‹•åˆä½µæ–·è¡Œä¸¦è½‰æ›</div>
    </div>

    <div class="header">
        <input type="text" id="urlInput" placeholder="è«‹è²¼ä¸Šç¶²å€..." value="http://alist.hopto.org/cat/BMW/tv2.txt">
        <div class="btn-group">
            <button onclick="startFetch()">è®€å–å…§å®¹</button>
            <button class="secondary" onclick="handleDownload('txt')">ä¸‹è¼‰ TXT</button>
            <button class="secondary" onclick="handleDownload('m3u')">ä¸‹è¼‰ M3U</button>
        </div>
    </div>

    <div class="content-area">
        <div class="log-panel">
            <div class="panel-label">SYSTEM LOG</div>
            <ul id="logEntries">
                <li class="log-item">ç³»çµ±å°±ç·’ã€‚</li>
            </ul>
        </div>
        <div class="result-panel">
            <div class="panel-label dark-label">FILE CONTENT</div>
            <pre id="contentBody">ç­‰å¾…è®€å–...</pre>
        </div>
    </div>
</div>

<script>
    let currentRawText = "";

    function addLog(msg, type = 'info') {
        const logContainer = document.getElementById('logEntries');
        const li = document.createElement('li');
        li.className = `log-item log-${type}`;
        const now = new Date().toLocaleTimeString('zh-TW', {hour12: false});
        li.innerText = `[${now}] ${msg}`;
        logContainer.appendChild(li);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    // å°‡æ–·è¡Œçš„è³‡æ–™é€²è¡Œåˆä½µè™•ç†ï¼šå¦‚æœä¸€è¡Œåªæœ‰åç¨±ï¼Œä¸‹ä¸€è¡Œæ˜¯ç¶²å€ï¼Œå‰‡åˆä½µ
    function cleanAndMergeLines(text) {
        const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l !== "");
        let merged = [];
        
        for (let i = 0; i < lines.length; i++) {
            let current = lines[i];
            // åˆ¤æ–·é‚è¼¯ï¼šå¦‚æœç•¶å‰è¡Œä¸å« http ä½†ä¸‹ä¸€è¡Œä»¥ http é–‹é ­æˆ–åŒ…å«é€—è™Ÿç¶²å€
            if (i < lines.length - 1 && !current.includes("http") && (lines[i+1].startsWith(",") || lines[i+1].includes("http"))) {
                let next = lines[i+1];
                // è™•ç†åƒ ",http..." é€™ç¨®æƒ…æ³
                if (next.startsWith(",")) {
                    merged.push(current + next);
                } else {
                    merged.push(current + "," + next);
                }
                i++; // è·³éä¸‹ä¸€è¡Œ
            } else {
                merged.push(current);
            }
        }
        return merged.join("\n");
    }

    function decodeBuffer(arrayBuffer) {
        const encodings = ["utf-8", "gbk", "big5"];
        let bestText = "", bestEnc = "utf-8", minErrors = Infinity;
        for (let enc of encodings) {
            try {
                const decoder = new TextDecoder(enc);
                const text = decoder.decode(arrayBuffer);
                const errorCount = (text.match(/\ufffd/g) || []).length;
                if (errorCount < minErrors) {
                    minErrors = errorCount;
                    bestText = text;
                    bestEnc = enc;
                }
                if (minErrors === 0) break;
            } catch(e) {}
        }
        return { text: bestText, encoding: bestEnc };
    }

    async function loadText(url, step = 0) {
        let targetUrl = url;
        const order = [0, 1, 2]; 
        const mode = order[step];
        const proxies = { 1: `https://corsproxy.io/?`, 2: `https://api.allorigins.win/raw?url=` };

        if (mode === 0) addLog(`å˜—è©¦ç›´æ¥é€£ç·š...`, 'info');
        else {
            targetUrl = proxies[mode] + encodeURIComponent(url);
            addLog(`é€£ç·šå¤±æ•—ï¼Œå˜—è©¦æ¨¡å¼ ${mode}...`, 'info');
        }

        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 12000); 
            const response = await fetch(targetUrl, { signal: controller.signal });
            clearTimeout(id);

            if (!response.ok) throw new Error(`HTTP ${response.status} å¤±æ•—`);
            const buffer = await response.arrayBuffer();
            const result = decodeBuffer(buffer);

            // è®€å–å¾Œç«‹å³é€²è¡Œæ–·è¡Œåˆä½µè™•ç†
            currentRawText = cleanAndMergeLines(result.text);
            document.getElementById('contentBody').innerText = currentRawText;
            addLog(`è®€å–ä¸¦åˆä½µæˆåŠŸï¼æ¨¡å¼ ${mode}ã€‚ç·¨ç¢¼ï¼š${result.encoding.toUpperCase()}`, 'success');

        } catch (err) {
            addLog(`æ¨¡å¼ ${mode} å¤±æ•—ï¼š${err.name === 'AbortError' ? 'é€£ç·šè¶…æ™‚' : err.message}`, 'error');
            if (step < order.length - 1) await loadText(url, step + 1);
            else addLog("æ‰€æœ‰æ¨¡å¼å˜—è©¦å¤±æ•—ã€‚", "error");
        }
    }

    function startFetch() {
        const url = document.getElementById('urlInput').value.trim();
        if (!url) return;
        document.getElementById('contentBody').innerText = "è¼‰å…¥ä¸­...";
        loadText(url, 0);
    }

    function getTimestamp() {
        const now = new Date();
        const pad = (n) => n.toString().padStart(2, '0');
        return now.getFullYear().toString() + pad(now.getMonth() + 1) + pad(now.getDate()) + pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds());
    }

    function handleDownload(type) {
        if (!currentRawText) return alert("è«‹å…ˆè®€å–å…§å®¹");
        
        let outputContent = currentRawText;
        const isM3UContent = currentRawText.trim().startsWith("#EXTM3U");
        const timestamp = getTimestamp();

        if (type === 'm3u') {
            if (!isM3UContent) {
                let m3u = "#EXTM3U\n";
                currentRawText.split('\n').forEach(line => {
                    if (line.includes(',')) {
                        const [name, link] = line.split(',');
                        if (link) m3u += `#EXTINF:-1,${name.trim()}\n${link.trim()}\n`;
                    }
                });
                outputContent = m3u;
            }
        } else if (type === 'txt') {
            if (isM3UContent) {
                let txt = "";
                const lines = currentRawText.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].startsWith("#EXTINF")) {
                        const name = lines[i].split(',')[1] || "æœªå‘½å";
                        const link = lines[i+1] ? lines[i+1].trim() : "";
                        if (link && !link.startsWith("#")) { txt += `${name},${link}\n`; }
                    }
                }
                outputContent = txt || currentRawText;
            }
        }

        const blob = new Blob([outputContent], { type: "text/plain" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `playlist_${timestamp}.${type}`;
        a.click();
        addLog(`ä¸‹è¼‰æˆåŠŸï¼šplaylist_${timestamp}.${type}`, 'success');
    }
</script>
</body>
</html>