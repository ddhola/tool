

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è¨˜æ†¶ç¿»ç‰Œå°éŠæˆ²3</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Arial', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; /* ä½¿ç”¨ min-height å¢å¼·å…¼å®¹æ€§ */
            color: white; 
            touch-action: manipulation;
            user-select: none;
            padding: 10px; /* å¢åŠ é‚Šè·é˜²æ­¢è²¼é‚Š */
        }
        canvas { 
            border: 5px solid rgba(255,255,255,0.3); 
            border-radius: 20px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.3); 
            max-width: 95vw; 
            max-height: 80vh; /* ç¨å¾®æ”¾å¯¬é™åˆ¶ */
            background: rgba(255,255,255,0.1);
            margin: 10px 0;
        }
        .info { 
            text-align: center; margin: 10px 0; 
            font-size: 18px; font-weight: bold; 
        }
        .restart { 
            padding: 15px 30px; font-size: 20px; 
            background: #ff6b6b; color: white; 
            border: none; border-radius: 50px; 
            cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.2); 
            transition: transform 0.2s; 
        }
        .restart:active { transform: scale(0.95); }
        .win { 
            position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            background: rgba(0,0,0,0.8); color: gold; 
            padding: 40px; border-radius: 20px; 
            text-align: center; font-size: 24px; 
            display: none; 
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="info">
        åˆ†æ•¸: <span id="score">0</span> | æ™‚é–“: <span id="time">0</span>s
    </div>
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <button class="restart" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
    
    <div class="win" id="winMsg">
        ğŸ‰ é€šé—œå•¦ï¼<br>
        æœ€çµ‚åˆ†æ•¸: <span id="finalScore">0</span><br>
        ç”¨æ™‚: <span id="finalTime">0</span>s
        <br><br>
        <button onclick="restartGame()" style="margin-top:20px; font-size:18px;">å†ç©ä¸€æ¬¡</button>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 4;
        const patterns = ['ğŸ', 'ğŸŒ', 'ğŸ‡', 'ğŸ“', 'ğŸŠ', 'ğŸ‰', 'ğŸ¥', 'ğŸ'];

        let currentCardSize; // è¿½è¹¤å¡ç‰‡å¤§å°
        let cards = [];
        let flipped = [];
        let matched = 0;
        let score = 0;
        let startTime = Date.now();
        let gameTimer;
        let isProcessingFlip = false; // é–å®šé»æ“Šï¼Œé¿å…å¿«é€Ÿé»æ“Šé€ æˆéŒ¯èª¤

        // =======================================================
        // æ ¸å¿ƒé‚è¼¯å‡½æ•¸
        // =======================================================

        function initCards() {
            clearInterval(gameTimer); // ç¢ºä¿åœæ­¢èˆŠè¨ˆæ™‚å™¨
            cards = [];
            const pairs = [...patterns, ...patterns];
            pairs.sort(() => Math.random() - 0.5); 
            for (let i = 0; i < gridSize * gridSize; i++) {
                cards.push({ pattern: pairs[i], flipped: false, matched: false });
            }
            flipped = [];
            matched = 0;
            score = 0;
            startTime = Date.now();
            updateScore();
            startTimer();
        }

        function drawCard(x, y, card) {
            if (!currentCardSize) return; // å®‰å…¨æª¢æŸ¥
            ctx.save();
            ctx.translate(x + currentCardSize/2, y + currentCardSize/2);
            
            const size = currentCardSize;

            if (card.matched) {
                ctx.globalAlpha = 0.5;
                ctx.font = `${size * 0.6}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(card.pattern, 0, size * 0.2); // æ ¹æ“šå¡ç‰‡å¤§å°èª¿æ•´æ–‡å­—ä½ç½®
            } else if (card.flipped) {
                ctx.fillStyle = '#4ecdc4';
                ctx.shadowColor = 'rgba(0,0,0,0.5)';
                ctx.shadowBlur = 10;
                ctx.fillRect(-size/2, -size/2, size, size);
                ctx.shadowBlur = 0;
                ctx.fillStyle = 'white';
                ctx.font = `bold ${size * 0.6}px Arial`;
                ctx.textAlign = 'center';
                ctx.fillText(card.pattern, 0, size * 0.2);
            } else {
                // èƒŒé¢
                const gradient = ctx.createLinearGradient(0, -size/2, 0, size/2);
                gradient.addColorStop(0, '#ff9a9e');
                gradient.addColorStop(1, '#fecfef');
                ctx.fillStyle = gradient;
                ctx.fillRect(-size/2, -size/2, size, size);
                ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                ctx.lineWidth = 5;
                ctx.strokeRect(-size/2 + 2, -size/2 + 2, size - 4, size - 4);
                
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.beginPath();
                ctx.arc(-size * 0.2, -size * 0.2, size * 0.3, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.restore();
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const idx = i * gridSize + j;
                    // ä½¿ç”¨ currentCardSize
                    drawCard(j * currentCardSize, i * currentCardSize, cards[idx]);
                }
            }
        }

        function flipCard(index) {
            if (isProcessingFlip) return; // é–å®š
            const card = cards[index];
            if (flipped.length < 2 && !card.flipped && !card.matched) {
                card.flipped = true;
                flipped.push(index);
                draw();

                if (flipped.length === 2) {
                    isProcessingFlip = true; // é–å®šé»æ“Š
                    setTimeout(checkMatch, 800);
                }
            }
        }

        function checkMatch() {
            const [idx1, idx2] = flipped;
            if (cards[idx1].pattern === cards[idx2].pattern) {
                cards[idx1].matched = true;
                cards[idx2].matched = true;
                matched++;
                score += 10;
                updateScore();
                if (matched === patterns.length) {
                    clearInterval(gameTimer);
                    document.getElementById('finalScore').textContent = score;
                    document.getElementById('finalTime').textContent = Math.floor((Date.now() - startTime) / 1000);
                    document.getElementById('winMsg').style.display = 'block';
                }
            } else {
                cards[idx1].flipped = false;
                cards[idx2].flipped = false;
            }
            flipped = [];
            isProcessingFlip = false; // è§£é–
            draw();
        }

        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        function startTimer() {
            startTime = Date.now();
            gameTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('time').textContent = elapsed;
            }, 1000);
        }

        // =======================================================
        // ä»‹é¢èˆ‡äº‹ä»¶è™•ç†
        // =======================================================

        function getIndex(clientX, clientY) {
            const rect = canvas.getBoundingClientRect();
            const x = clientX - rect.left;
            const y = clientY - rect.top;
            
            // æª¢æŸ¥ currentCardSize æ˜¯å¦æœ‰æ•ˆ
            if (!currentCardSize || currentCardSize <= 0) return -1; 
            
            const col = Math.floor(x / currentCardSize);
            const row = Math.floor(y / currentCardSize);
            if (col >= 0 && col < gridSize && row >= 0 && row < gridSize) {
                return row * gridSize + col;
            }
            return -1;
        }

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const idx = getIndex(touch.clientX, touch.clientY);
            if (idx !== -1) flipCard(idx);
        }, { passive: false });

        canvas.addEventListener('click', (e) => {
            const idx = getIndex(e.clientX, e.clientY);
            if (idx !== -1) flipCard(idx);
        });

        // é‡æ–°é–‹å§‹ (è¨­ç‚ºå…¨åŸŸå‡½æ•¸ä»¥ä¾› HTML æŒ‰éˆ•èª¿ç”¨)
        window.restartGame = function() {
            document.getElementById('winMsg').style.display = 'none';
            clearInterval(gameTimer);
            initCards();
            draw();
        }

        // è‡ªé©æ‡‰ç•«å¸ƒå¤§å° - **ç¢ºä¿é¡¯ç¤ºçš„æ ¸å¿ƒå‡½æ•¸**
        function resizeCanvas() {
            // é€™æ˜¯é—œéµä¿®æ­£ï¼šè¨ˆç®—ç•«å¸ƒå¤§å°æ™‚ï¼Œè¦å¾ viewport ä¸­æ¸›å»è³‡è¨Šåˆ—å’ŒæŒ‰éˆ•æ‰€ä½”çš„å‚ç›´ç©ºé–“
            const availableHeight = window.innerHeight * 0.95 - 150; // æ¸›å»ç´„ 150px çµ¦ä¸Šæ–¹çš„åˆ†æ•¸å’Œä¸‹æ–¹çš„æŒ‰éˆ•
            const availableWidth = window.innerWidth * 0.95; 

            // ä½¿ç”¨è¼ƒçŸ­çš„å¯ç”¨é‚Šä½œç‚ºç•«å¸ƒçš„æ­£æ–¹å½¢å°ºå¯¸
            const size = Math.min(availableWidth, availableHeight);
            
            // ç¢ºä¿ size ä¸ç‚ºè² æˆ–é›¶
            if (size > 100) { 
                canvas.width = size;
                canvas.height = size;
                
                currentCardSize = canvas.width / gridSize; 
                
                // é‡æ–°åˆå§‹åŒ–å’Œç¹ªè£½ï¼Œä½†åªåœ¨ç•«å¸ƒå°ºå¯¸æ”¹è®Šæ™‚
                if (cards.length === 0 || matched === patterns.length) {
                     initCards();
                }
                draw();
            } else {
                 // å°ºå¯¸éå°ï¼Œä¸åšåˆå§‹åŒ–ï¼Œå¯èƒ½æç¤ºç”¨æˆ¶æ—‹è½‰è¢å¹•
                 console.log("Canvas å°ºå¯¸éå°ï¼Œç„¡æ³•åˆå§‹åŒ–ã€‚");
            }
        }

        // =======================================================
        // å•Ÿå‹•é»
        // =======================================================
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas(); // åˆå§‹èª¿æ•´ä¸¦å•Ÿå‹•éŠæˆ²

    </script>
</body>
</html>