<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>IPTV M3U â‡„ TXT é›™å‘è½‰æ›å·¥å…· (è‡ªå‹•è¾¨è­˜ç·¨ç¢¼ï½œæ”¯æ´å¤šæª”åˆä½µï½œåŸå§‹é †åºè½‰æ›)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: system-ui, -apple-system, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 1000px;
  margin: auto;
}
h1 {
  text-align: center;
  color: #2c3e50;
  margin-bottom: 10px;
}
.drop-zone {
  border: 3px dashed #aaa;
  border-radius: 12px;
  padding: 40px;
  background: white;
  text-align: center;
  cursor: pointer;
  transition: 0.2s;
  color: #555;
  margin-bottom: 15px;
}
.drop-zone.dragover {
  border-color: #3498db;
  background: #eaf4ff;
}
#status {
  text-align: center;
  color: #e67e22;
  font-weight: bold;
  min-height: 1.5em;
  margin-bottom: 10px;
}
textarea {
  width: 100%;
  min-height: 240px;
  margin-top: 10px;
  padding: 12px;
  font-family: Consolas, monospace;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}
button {
  padding: 10px 18px;
  margin: 5px 4px 0 0;
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  font-weight: 500;
}
.btn-main { background: #3498db; }
.btn-paste { background: #8e44ad; }
.btn-copy { background: #27ae60; }
.btn-clear { background: #e74c3c; }
.btn-main:hover { opacity: 0.9; }

.info {
  text-align: center;
  color: #7f8c8d;
  margin-top: 20px;
  font-size: 0.9em;
  line-height: 1.6;
}
</style>
</head>
<body>

<div class="container">
  <h1>IPTV M3U â‡„ TXT é›™å‘è½‰æ›</h1>
  
  <div id="status">æº–å‚™å°±ç·’</div>

  <div class="drop-zone" id="dropZone">
    æ‹–æ”¾å¤šå€‹ .m3u / .m3u8 / .txt åˆ°é€™è£¡<br>
    æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ (æ”¯æ´ UTF-8 / GBK / Big5)
    <input type="file" id="fileInput" multiple hidden>
  </div>

  <div>
    <button class="btn-main" onclick="fileInput.click()">é¸æ“‡æª”æ¡ˆ</button>
    <button class="btn-paste" onclick="pasteFromClipboard()">å¾å‰ªè²¼ç°¿è²¼ä¸Š</button>
    <button class="btn-copy" onclick="copyResult()">è¤‡è£½çµæœ</button>
    <button class="btn-main" onclick="downloadM3U()">â¬‡ ä¸‹è¼‰ M3U</button>
    <button class="btn-main" onclick="downloadTXT()">â¬‡ ä¸‹è¼‰ TXT</button>
    <button class="btn-clear" onclick="clearAll()">æ¸…é™¤</button>
  </div>

  <textarea id="input" placeholder="è®€å–çš„åŸå§‹å…§å®¹ï¼ˆå¤šæª”æœƒåˆä½µï¼‰..."></textarea>
  <textarea id="output" placeholder="è½‰æ›çµæœ..."></textarea>

  <div class="info">
    è‡ªå‹•è¾¨è­˜ç·¨ç¢¼ï½œæ”¯æ´å¤šæª”åˆä½µï½œåŸå§‹é †åºè½‰æ›<br>
    TXT åˆ†é¡ (<code>#genre#</code>) â†” M3U <code>group-title</code>
  </div>
</div>

<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const input = document.getElementById('input');
const output = document.getElementById('output');
const statusDiv = document.getElementById('status');

/* ---------- æ ¸å¿ƒï¼šè‡ªå‹•è§£ç¢¼åŠŸèƒ½ ---------- */
function autoDecode(arrayBuffer) {
  const encodings = ["utf-8", "gbk", "big5"];
  let bestText = "";
  let bestEncoding = "utf-8";
  let minInvalid = Infinity;

  for (let enc of encodings) {
    try {
      const decoder = new TextDecoder(enc, { fatal: true });
      const text = decoder.decode(arrayBuffer);
      // æª¢æŸ¥æ›¿æ›å­—å…ƒæ•¸é‡ (\ufffd)
      const invalidCount = (text.match(/\ufffd/g) || []).length;
      
      if (invalidCount < minInvalid) {
        minInvalid = invalidCount;
        bestText = text;
        bestEncoding = enc;
      }
      if (invalidCount === 0) break; 
    } catch (e) {
      continue;
    }
  }
  return { text: bestText, encoding: bestEncoding };
}

/* ---------- æ‹–æ”¾èˆ‡æª”æ¡ˆè™•ç† ---------- */
['dragenter','dragover'].forEach(e =>
  dropZone.addEventListener(e, ev => {
    ev.preventDefault();
    dropZone.classList.add('dragover');
  })
);
['dragleave','drop'].forEach(e =>
  dropZone.addEventListener(e, ev => {
    ev.preventDefault();
    dropZone.classList.remove('dragover');
  })
);

dropZone.onclick = () => fileInput.click();

dropZone.ondrop = e => {
  handleFiles(e.dataTransfer.files);
};

fileInput.onchange = e => {
  handleFiles(e.target.files);
};

function handleFiles(fileList) {
  if (!fileList || fileList.length === 0) return;

  const files = Array.from(fileList);
  input.value = '';
  output.value = '';
  let index = 0;

  function readNext() {
    if (index >= files.length) {
      statusDiv.textContent = `âœ… è®€å–å®Œæˆ (${files.length} å€‹æª”æ¡ˆ)ï¼Œæ­£åœ¨è½‰æ›...`;
      convert();
      return;
    }

    const file = files[index++];
    const reader = new FileReader();

    reader.onload = e => {
      const result = autoDecode(e.target.result);
      input.value += (input.value ? '\n' : '') + result.text.trim();
      statusDiv.textContent = `æ­£åœ¨è®€å– (${index}/${files.length}) - åµæ¸¬ç·¨ç¢¼: ${result.encoding.toUpperCase()}`;
      readNext();
    };

    reader.readAsArrayBuffer(file);
  }

  readNext();
}

/* ---------- è½‰æ›é‚è¼¯ ---------- */
function convert() {
  const text = input.value.trim();
  if (!text) return;

  // åˆ¤æ–·æ˜¯å¦ç‚º M3U æ ¼å¼
  if (text.startsWith('#EXTM3U') || text.includes('#EXTINF')) {
    output.value = m3uToTxt(text);
    statusDiv.textContent = "âœ… å·²å®Œæˆè½‰æ›ï¼šM3U â” TXT";
  } else {
    output.value = txtToM3U(text);
    statusDiv.textContent = "âœ… å·²å®Œæˆè½‰æ›ï¼šTXT â” M3U";
  }
}

/* M3U -> TXT */
function m3uToTxt(text) {
  const lines = text.split(/\r?\n/);
  const out = [];
  const printedGroups = new Set();
  let currentTitle = null, currentGroup = null;

  for (let line of lines) {
    line = line.trim();
    if (!line) continue;

    if (line.startsWith('#EXTINF')) {
      // æå– group-title
      const g = line.match(/group-title="([^"]+)"/i);
      currentGroup = g ? g[1] : 'æœªåˆ†é¡';
      // æå–æ¨™é¡Œï¼ˆæœ€å¾Œä¸€å€‹é€—è™Ÿå¾Œé¢çš„å…§å®¹ï¼‰
      currentTitle = line.split(',').pop() || 'ç„¡æ¨™é¡Œ';

      if (!printedGroups.has(currentGroup)) {
        out.push(`${currentGroup},#genre#`);
        printedGroups.add(currentGroup);
      }
    } else if (line.startsWith('http')) {
      if (currentTitle) {
        out.push(`${currentTitle},${line}`);
      }
    }
  }
  return out.join('\n');
}

/* TXT -> M3U */
function txtToM3U(text) {
  const lines = text.split(/\r?\n/);
  const out = ['#EXTM3U'];
  let currentGroup = 'æœªåˆ†é¡';

  for (let line of lines) {
    line = line.trim();
    if (!line) continue;

    if (line.endsWith(',#genre#')) {
      currentGroup = line.replace(',#genre#','').trim() || 'æœªåˆ†é¡';
    } else {
      const parts = line.split(',');
      if (parts.length >= 2) {
        const title = parts[0].trim();
        const url = parts.slice(1).join(',').trim(); // è™•ç† URL ä¸­å¯èƒ½å«é€—è™Ÿçš„æƒ…æ³
        if (url.startsWith('http')) {
          out.push(`#EXTINF:-1 group-title="${currentGroup}",${title}`);
          out.push(url);
        }
      }
    }
  }
  return out.join('\n');
}

/* ---------- å…¶ä»–å·¥å…·åŠŸèƒ½ ---------- */
async function pasteFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    if (text.trim()) {
      input.value = text.trim();
      convert();
      statusDiv.textContent = "ğŸ“‹ å·²å¾å‰ªè²¼ç°¿è²¼ä¸Šä¸¦è½‰æ›";
    }
  } catch (err) {
    statusDiv.textContent = "âŒ ç„¡æ³•è®€å–å‰ªè²¼ç°¿ï¼Œè«‹æ‰‹å‹•è²¼ä¸Š";
  }
}

function getTimestamp() {
  const d = new Date();
  const pad = n => String(n).padStart(2, '0');
  return d.getFullYear() + pad(d.getMonth()+1) + pad(d.getDate()) + '_' + pad(d.getHours()) + pad(d.getMinutes());
}

function downloadFile(content, filename) {
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

function downloadM3U() {
  let text = output.value.trim();
  if (!text) return alert('æ²’æœ‰å…§å®¹å¯ä»¥ä¸‹è¼‰');
  if (!text.startsWith('#EXTM3U')) text = txtToM3U(text);
  downloadFile(text, `iptv_${getTimestamp()}.m3u`);
}

function downloadTXT() {
  let text = output.value.trim();
  if (!text) return alert('æ²’æœ‰å…§å®¹å¯ä»¥ä¸‹è¼‰');
  if (text.startsWith('#EXTM3U')) text = m3uToTxt(text);
  downloadFile(text, `iptv_${getTimestamp()}.txt`);
}

function copyResult() {
  if (!output.value) return;
  output.select();
  document.execCommand('copy');
  statusDiv.textContent = "âœ¨ å·²è¤‡è£½è½‰æ›çµæœåˆ°å‰ªè²¼ç°¿";
}

function clearAll() {
  input.value = '';
  output.value = '';
  fileInput.value = '';
  statusDiv.textContent = "å·²æ¸…é™¤æ‰€æœ‰å…§å®¹";
}
</script>

</body>
</html>