<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>FM 廣播電臺 - 穩定修復版</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
<style>
    /* 基本佈局 */
    body { margin: 0; background: #000; color: #fff; font-family: -apple-system, sans-serif; height: 100vh; display: flex; overflow: hidden; }
    
    /* 左側列表 */
    #left-panel { flex: 2; border-right: 1px solid #222; display: flex; flex-direction: column; height: 100vh; }
    #station-list { padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; overflow-y: auto; }
    
    /* 右側播放區 */
    #right-panel { flex: 3; display: flex; flex-direction: column; background: #080808; height: 100vh; position: relative; }
    #info-area { padding: 30px 20px 10px 20px; text-align: center; }
    #station-name { font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; color: #fff; }
    
    /* 歌詞捲動區 */
    #lyrics-container { flex-grow: 1; overflow: hidden; position: relative; mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%); }
    #lyrics-wrapper { transition: transform 0.5s ease-out; text-align: center; padding-top: 20px; }
    .lyric-line { font-size: 0.95rem; padding: 10px 20px; transition: all 0.4s ease; line-height: 1.5; color: #444; }
    .lyric-line.active { color: #fff; font-size: 1.2rem; font-weight: bold; text-shadow: 0 0 10px rgba(255,255,255,0.3); }

    /* 播放控制膠囊 */
    #controls-area { padding: 20px 0 40px 0; display: flex; justify-content: center; background: linear-gradient(to top, #080808 80%, transparent); }
    .player-pill { background: #fff; border-radius: 999px; padding: 8px 16px; width: 85%; max-width: 400px; }
    audio { width: 100%; height: 34px; }

    /* 按鈕樣式 */
    .station-btn { background: #111; color: #ccc; border: 1px solid #333; border-radius: 8px; padding: 10px 12px; cursor: pointer; text-align: left; font-size: 0.85rem; transition: 0.2s; }
    .station-btn:hover { background: #222; color: #fff; }
    .station-btn.active { border-color: #d4af37; color: #fff; background: #1a1a00; }
    
    /* 狀態提示 */
    .status-msg { padding: 20px; text-align: center; color: #888; grid-column: span 2; font-size: 0.9rem; }
    .error-path { color: #ff4d4d; font-family: monospace; font-size: 0.75rem; word-break: break-all; margin-top: 10px; display: block; }
</style>
</head>
<body>

<div id="left-panel">
    <div id="station-list">
        <div class="status-msg" id="loading-text">正在連線至 GitHub 讀取 fmlist.txt...</div>
    </div>
</div>

<div id="right-panel">
    <div id="info-area">
        <div id="station-name">請選擇電台</div>
    </div>
    <div id="lyrics-container">
        <div id="lyrics-wrapper">
            <div class="lyric-line active">準備就緒</div>
        </div>
    </div>
    <div id="controls-area">
        <div class="player-pill">
            <audio id="audio" controls crossorigin="anonymous"></audio>
        </div>
    </div>
</div>

<script>
const audio = document.getElementById("audio");
const stationListEl = document.getElementById("station-list");
const stationNameDisp = document.getElementById("station-name");
const loadingText = document.getElementById("loading-text");

// 根據您的截圖，這是最正確的純文字路徑
const FINAL_URL = "https://raw.githubusercontent.com/ddhola/tool/main/fmlist.txt";

async function init() {
    try {
        // 1. 設定 10 秒超時，避免網路不穩時無限卡死
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        // 2. 抓取檔案 (加上時間戳 t= 避開快取)
        const response = await fetch(`${FINAL_URL}?t=${Date.now()}`, { signal: controller.signal });
        clearTimeout(timeoutId);

        if (!response.ok) throw new Error(`連線失敗 (HTTP ${response.status})`);
        
        const text = await response.text();

        // 3. 檢查內容是否為 GitHub 的網頁 HTML (如果是的話會包含 <!DOCTYPE)
        if (text.includes("<!DOCTYPE html>")) {
            throw new Error("抓取到的是網頁原始碼而非純文字，請確認路徑是否正確。");
        }

        renderList(text);
    } catch (err) {
        console.error("Init Error:", err);
        stationListEl.innerHTML = `
            <div class="status-msg" style="color:#ff4d4d;">
                <strong>⚠️ 讀取清單失敗</strong><br>
                原因：${err.message}
                <span class="error-path">嘗試路徑：${FINAL_URL}</span>
            </div>`;
        stationNameDisp.textContent = "載入失敗";
    }
}

function renderList(text) {
    const lines = text.trim().split('\n');
    stationListEl.innerHTML = ""; // 清空載入中文字

    lines.forEach(line => {
        const parts = line.split(',');
        if (parts.length < 1) return;
        
        const name = parts[0].trim();
        const url = parts.slice(1).join(',').trim();
        if (!name) return;

        const btn = document.createElement("button");
        btn.className = "station-btn";
        btn.textContent = name;
        
        btn.onclick = () => {
            // 切換按鈕狀態
            document.querySelectorAll(".station-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            stationNameDisp.textContent = name;
            
            // 播放處理
            audio.pause();
            audio.src = url;
            audio.play().catch(e => {
                console.warn("自動播放被攔截或網址失效:", e);
                alert("該電台目前無法播放，請檢查網址是否有效。");
            });
        };
        stationListEl.appendChild(btn);
    });

    if (stationListEl.children.length === 0) {
        stationListEl.innerHTML = '<div class="status-msg">FM.txt 內沒有有效的電台資料</div>';
    }
}

// 執行
init();
</script>
</body>
</html>
