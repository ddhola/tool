<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>IPTV æ•´åˆç³»çµ± - å¤šæºæ‰¹æ¬¡ç‰ˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
    <style>
        :root { --primary: #1a73e8; --success: #34a853; --warning: #f9ab00; --error: #ea4335; --dark: #202124; --bg: #f8f9fa; --border: #dadce0; }
        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; margin: 0; background: var(--bg); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: white; padding: 0 20px; height: 60px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); z-index: 10; }
        .logo { font-size: 1.2rem; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 8px; }
        .status-area { display: flex; align-items: center; gap: 15px; font-size: 0.85rem; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; background: #ccc; }
        .dot-green { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .dot-blue { background: var(--primary); box-shadow: 0 0 5px var(--primary); }
        .dot-red { background: var(--error); box-shadow: 0 0 5px var(--error); }
        main { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 350px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .card { background: #fff; border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .card-title { font-weight: bold; margin-bottom: 12px; font-size: 0.95rem; color: var(--dark); border-left: 4px solid var(--primary); padding-left: 8px; }
        .content-area { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 20px; overflow: hidden; }
        .url-bar { display: flex; flex-direction: column; gap: 10px; background: white; padding: 10px; border-radius: 8px; border: 1px solid var(--border); }
        #urlInput { width: 100%; height: 80px; border: 1px solid #ccc; border-radius: 4px; padding: 8px 12px; outline: none; font-family: Consolas, monospace; resize: vertical; box-sizing: border-box; }
        .editor-grid { flex: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; min-height: 0; }
        .editor-container { display: flex; flex-direction: column; gap: 8px; }
        textarea { flex: 1; border: 1px solid var(--border); border-radius: 6px; padding: 12px; font-family: 'Consolas', monospace; font-size: 12px; resize: none; background: white; }
        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: white; border: 1px solid var(--border); color: var(--dark); }
        .full-width { width: 100%; margin-top: 5px; }
        #logPanel { height: 180px; background: #2d3436; color: #dfe6e9; border-radius: 6px; padding: 10px; font-family: Consolas, monospace; font-size: 11px; overflow-y: auto; line-height: 1.4; }
        .drop-zone { border: 2px dashed var(--primary); background: rgba(26, 115, 232, 0.05); text-align: center; padding: 15px; border-radius: 8px; cursor: pointer; font-size: 0.9rem; color: #555; }
    </style>
</head>
<body>

<header>
    <div class="logo">ğŸ“„ IPTV æ•´åˆç³»çµ± <small id="ruleStatus">åˆå§‹åŒ–...</small></div>
    <div class="status-area">
        <span id="dot" class="status-dot"></span>
        <button class="btn-outline" onclick="clearAll()" style="padding: 4px 10px; font-size: 0.7rem;">å…¨éƒ¨æ¸…é™¤è³‡æ–™</button>
    </div>
</header>

<main>
    <div class="sidebar">
        <div class="card">
            <div class="card-title">1. è¦å‰‡ç®¡ç† (åŒæ­¥å„ªå…ˆ)</div>
            <button class="btn-outline full-width" onclick="initRuleFlow()">ğŸ”„ é‡æ–°æ•´ç† GitHub è¦å‰‡</button>
            <button class="btn-outline full-width" onclick="document.getElementById('ruleFileManual').click()" style="margin-top:5px;">ğŸ“‚ æ‰‹å‹•è¼‰å…¥æœ¬åœ°è¦å‰‡</button>
            <input type="file" id="ruleFileManual" style="display:none;" onchange="loadRuleManual(this)">
        </div>
        <div class="card">
            <div class="card-title">2. è™•ç†é¸é …</div>
            <label style="display: flex; align-items: center; font-size: 0.85rem; margin-bottom: 8px;">
                <input type="checkbox" id="autoTW" checked onchange="saveOptions()"> è‡ªå‹•å°ç£ç¹é«” (OpenCC)
            </label>
            <label style="display: flex; align-items: center; font-size: 0.85rem; margin-bottom: 8px;">
                <input type="checkbox" id="fixLines" checked onchange="saveOptions()"> è‡ªå‹•ä¿®å¾©æ–·è¡Œ
            </label>
            <button class="btn-primary full-width" style="margin-top: 10px; height: 40px;" onclick="startProcess()">ğŸš€ é–‹å§‹åˆ†æä¸¦è½‰æ›</button>
        </div>
        <div id="logPanel"></div>
    </div>

    <div class="content-area">
        <div class="url-bar">
            <textarea id="urlInput" placeholder="è¼¸å…¥é ç«¯ç¶²å€ (æ¯è¡Œä¸€å€‹)..."></textarea>
            <button class="btn-primary" style="align-self: flex-end;" onclick="fetchMultipleUrls()">æ‰¹é‡è®€å–ä¾†æº</button>
        </div>
        <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
            å°‡æª”æ¡ˆ (.txt / .m3u) æ‹–æ”¾è‡³æ­¤æˆ–é»æ“Šé¸å–
            <input type="file" id="fileInput" multiple hidden onchange="handleFileSelect(this)">
        </div>
        <div class="editor-grid">
            <div class="editor-container">
                <div style="font-size: 0.8rem; font-weight: bold; color: #5f6368;">åŸå§‹å…§å®¹ / é è™•ç† TXT</div>
                <textarea id="sourceArea" oninput="saveSessionData()"></textarea>
                <div style="display: flex; gap: 5px;">
                    <button class="btn-success full-width" onclick="downloadFile('txt')">ğŸ“¥ ä¸‹è¼‰ç´”æ·¨ TXT</button>
                </div>
            </div>
            <div class="editor-container">
                <div style="font-size: 0.8rem; font-weight: bold; color: #5f6368;">è¦å‰‡éæ¿¾å¾Œ Result (M3U) <span id="channelCount"></span></div>
                <textarea id="resultArea" readonly></textarea>
                <div style="display: flex; gap: 5px;">
                    <button class="btn-success full-width" onclick="downloadFile('m3u')">ğŸ“¥ ä¸‹è¼‰ M3U</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    const GITHUB_RULE_URL = "all_rules.txt"; 
    let keepSet = new Set(), categoryMap = [], sortRef = {};
    const toTW = OpenCC.Converter({ from: 'cn', to: 'twp' });

    window.onload = () => { 
        loadOptions();
        initRuleFlow(); 
        loadSessionData();
        addLog("ç³»çµ±å°±ç·’ã€‚"); 
    };

    function addLog(msg, type) {
        const panel = document.getElementById('logPanel');
        const div = document.createElement("div");
        if(type === "error") div.style.color = "#f28b82";
        if(type === "success") div.style.color = "#81c995";
        div.textContent = `[${new Date().toLocaleTimeString().split(' ')[0]}] ${msg}`;
        panel.appendChild(div);
        panel.scrollTop = panel.scrollHeight;
    }

    function saveOptions() {
        localStorage.setItem('iptv_opt_tw', document.getElementById('autoTW').checked);
        localStorage.setItem('iptv_opt_fix', document.getElementById('fixLines').checked);
    }

    function loadOptions() {
        if (localStorage.getItem('iptv_opt_tw') !== null) 
            document.getElementById('autoTW').checked = localStorage.getItem('iptv_opt_tw') === 'true';
        if (localStorage.getItem('iptv_opt_fix') !== null) 
            document.getElementById('fixLines').checked = localStorage.getItem('iptv_opt_fix') === 'true';
    }

    function saveSessionData() {
        localStorage.setItem('iptv_last_source', document.getElementById('sourceArea').value);
        localStorage.setItem('iptv_last_url', document.getElementById('urlInput').value);
    }

    function loadSessionData() {
        const lastSource = localStorage.getItem('iptv_last_source');
        const lastUrl = localStorage.getItem('iptv_last_url');
        if (lastSource) document.getElementById('sourceArea').value = lastSource;
        if (lastUrl) document.getElementById('urlInput').value = lastUrl;
    }

    async function initRuleFlow() {
        setUIState("status-dot", "æ­£åœ¨åŒæ­¥è¦å‰‡...");
        try {
            const res = await fetch(GITHUB_RULE_URL, { cache: "no-store" });
            if (!res.ok) throw new Error("File not found");
            const text = await res.text();
            parseRules(text);
            localStorage.setItem('all_rules_cache', text);
            setUIState("dot-green", "è¦å‰‡å·²å°±ç·’ (æœ€æ–°)");
            addLog("ä¼ºæœå™¨è¦å‰‡æŠ“å–æˆåŠŸ", "success");
        } catch (err) {
            const cached = localStorage.getItem('all_rules_cache');
            if (cached) {
                parseRules(cached);
                setUIState("dot-blue", "è¦å‰‡å·²å°±ç·’ (å¿«å–)");
                addLog("å·²è¼‰å…¥è¨˜æ†¶è¦å‰‡", "success");
            } else {
                setUIState("dot-red", "è¦å‰‡ç¼ºå¤±");
                addLog("æ‰¾ä¸åˆ°è¦å‰‡ï¼Œè«‹æ‰‹å‹•ä¸Šå‚³", "error");
            }
        }
    }

    function setUIState(cls, msg) {
        document.getElementById('dot').className = "status-dot " + cls;
        document.getElementById('ruleStatus').innerText = msg;
    }

    function parseRules(text) {
        keepSet.clear(); categoryMap = []; sortRef = {};
        const lines = text.split(/\r?\n/);
        let section = ""; let curCat = null, curSortCat = null;
        lines.forEach(l => {
            let line = l.trim(); if (!line || line.startsWith("#")) return;
            if (line === "[KEEP_LIST]") { section = "KEEP"; return; }
            if (line === "[CATEGORY_LIST]") { section = "CATEGORY"; return; }
            if (line === "[SORT_LIST]") { section = "SORT"; return; }
            if (section === "KEEP") keepSet.add(line.toUpperCase());
            else if (section === "CATEGORY") {
                if (line.includes("#genre#")) {
                    curCat = { name: line.split(",")[0].trim(), keywords: [] };
                    categoryMap.push(curCat);
                } else if (curCat) curCat.keywords.push(line.toUpperCase());
            } else if (section === "SORT") {
                if (line.includes("#genre#")) {
                    curSortCat = line.split(",")[0].trim();
                    sortRef[curSortCat] = [];
                } else if (curSortCat) sortRef[curSortCat].push(line.toUpperCase());
            }
        });
    }

    function loadRuleManual(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = e => {
            const text = e.target.result;
            localStorage.setItem('all_rules_cache', text);
            parseRules(text);
            setUIState("dot-green", "è¦å‰‡å·²æ‰‹å‹•æ›´æ–°");
            addLog(`æ‰‹å‹•è¦å‰‡è¼‰å…¥æˆåŠŸ: ${file.name}`, "success");
        };
        reader.readAsText(file, "utf-8");
    }

    async function handleFileSelect(input) {
        let combinedText = "";
        for (let file of Array.from(input.files)) {
            const buffer = await file.arrayBuffer();
            const result = autoDecode(buffer);
            combinedText += (combinedText ? "\n" : "") + result.text.trim();
            addLog(`æª”æ¡ˆè¼‰å…¥: ${file.name}`);
        }
        processInput(combinedText);
        saveSessionData();
    }

    function autoDecode(buffer) {
        const encodings = ["utf-8", "gbk", "big5"];
        for (let enc of encodings) {
            try { const decoder = new TextDecoder(enc, { fatal: true }); return { text: decoder.decode(buffer), encoding: enc }; } catch {}
        }
        return { text: new TextDecoder("utf-8").decode(buffer), encoding: "utf-8" };
    }

    function processInput(text) {
        let content = text;
        if (document.getElementById('fixLines').checked) {
            const lines = content.split(/\r?\n/).map(l => l.trim()).filter(l => l);
            let merged = [];
            for (let i = 0; i < lines.length; i++) {
                if (i < lines.length - 1 && !lines[i].startsWith("#") && !lines[i].includes("http") && (lines[i+1].includes("http") || lines[i+1].startsWith(","))) {
                    let next = lines[i+1].startsWith(",") ? lines[i+1] : "," + lines[i+1];
                    merged.push(lines[i] + next); i++;
                } else { merged.push(lines[i]); }
            }
            content = merged.join("\n");
        }
        if (document.getElementById('autoTW').checked) content = toTW(content);
        document.getElementById('sourceArea').value = content;
        addLog("é è™•ç†å…§å®¹å·²æ›´æ–°ã€‚");
    }

    // --- æ–°å¢ï¼šæ‰¹æ¬¡æŠ“å–é ç«¯ç¶²å€é‚è¼¯ ---
    async function fetchMultipleUrls() {
        const urlInput = document.getElementById('urlInput').value;
        const urls = urlInput.split(/\r?\n/).map(u => u.trim()).filter(u => u);
        if (urls.length === 0) return addLog("è«‹è¼¸å…¥è‡³å°‘ä¸€å€‹ç¶²å€", "error");

        saveSessionData();
        addLog(`é–‹å§‹æ‰¹é‡è®€å– ${urls.length} å€‹ä¾†æº...`);
        
        let combinedContent = "";
        const proxies = ["", "https://corsproxy.io/?", "https://api.allorigins.win/raw?url="];

        for (const url of urls) {
            let success = false;
            addLog(`è®€å–ä¸­: ${url.substring(0, 50)}${url.length > 50 ? '...' : ''}`);
            
            for (let i = 0; i < proxies.length; i++) {
                try {
                    const res = await fetch(proxies[i] + (i === 0 ? url : encodeURIComponent(url)));
                    if (res.ok) {
                        const buffer = await res.arrayBuffer();
                        const text = autoDecode(buffer).text;
                        combinedContent += (combinedContent ? "\n" : "") + text.trim();
                        addLog(`[æˆåŠŸ] ä¾†æº: ${url.split('/').pop() || 'Remote'}`, "success");
                        success = true;
                        break;
                    }
                } catch (e) {}
            }
            if (!success) addLog(`[å¤±æ•—] ç„¡æ³•é€£ç·š: ${url}`, "error");
        }

        if (combinedContent) {
            processInput(combinedContent);
            addLog("æ‰€æœ‰ä¾†æºæŠ“å–å®Œç•¢ä¸¦å·²åˆä½µè‡³ç·¨è¼¯å€ã€‚", "success");
        }
    }

    function startProcess() {
        const inputStr = document.getElementById('sourceArea').value;
        if (!inputStr || keepSet.size === 0) return addLog("éŒ¯èª¤ï¼šè¦å‰‡æˆ–é »é“æºæœªå°±ç·’", "error");
        
        let sourceData = [];
        const regex = /(?:#EXTINF.*?,|)([^,\n#]+?)[,\s]+(https?:\/\/[^\s\n,]+)/gi;
        let match;
        while ((match = regex.exec(inputStr)) !== null) {
            sourceData.push({ name: match[1].trim(), url: match[2].trim() });
        }

        if (sourceData.length === 0) {
            inputStr.split(/\r?\n/).forEach(l => {
                const p = l.split(",");
                if (p.length >= 2 && p[1].includes("http")) sourceData.push({name: p[0].trim(), url: p[1].trim()});
            });
        }

        let results = {}, seenUrls = new Set(), count = 0;
        sourceData.forEach(item => {
            if (seenUrls.has(item.url)) return;
            const up = item.name.toUpperCase();
            let keep = false;
            for (let k of keepSet) { if (up.includes(k)) { keep = true; break; } }
            if (!keep) return;

            seenUrls.add(item.url);
            let cat = "å…¶ä»–";
            for (let c of categoryMap) { if (c.keywords.some(k => up.includes(k))) { cat = c.name; break; } }
            if (!results[cat]) results[cat] = [];
            results[cat].push({name: item.name, url: item.url, up});
            count++;
        });

        let m3uOut = "#EXTM3U\n";
        let txtOut = "";
        categoryMap.forEach(c => {
            if (results[c.name]) {
                const ref = sortRef[c.name] || [];
                results[c.name].sort((a,b) => {
                    let iA = ref.findIndex(k => a.up.includes(k)), iB = ref.findIndex(k => b.up.includes(k));
                    if (iA !== -1 && iA === iB) return a.name.localeCompare(b.name, 'zh-Hant', {numeric:true});
                    return (iA !== -1 && iB !== -1) ? iA - iB : (iA !== -1) ? -1 : (iB !== -1) ? 1 : a.name.localeCompare(b.name, 'zh-Hant', {numeric:true});
                });
                txtOut += `${c.name},#genre#\n`;
                results[c.name].forEach(i => {
                    txtOut += `${i.name},${i.url}\n`;
                    m3uOut += `#EXTINF:-1 group-title="${c.name}",${i.name}\n${i.url}\n`;
                });
            }
        });

        document.getElementById('resultArea').value = m3uOut;
        window.tempTxtOutput = txtOut;
        document.getElementById('channelCount').innerText = `(${count})`;
        addLog(`è½‰æ›å®Œæˆï¼Œå…± ${count} é »é“`, "success");
    }

    function downloadFile(ext) {
        let content = (ext === 'm3u') ? document.getElementById('resultArea').value : window.tempTxtOutput;
        if (!content) return alert("è«‹å…ˆé€²è¡Œè½‰æ›");
        const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        const ts = new Date().toISOString().replace(/[-:T]/g, '').slice(0, 14);
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `iptv_${ts}.${ext}`;
        a.click();
    }

    function clearAll() { 
        document.querySelectorAll('textarea').forEach(t => t.value=""); 
        localStorage.removeItem('iptv_last_source');
        localStorage.removeItem('iptv_last_url');
        addLog("å·²æ¸…é™¤è³‡æ–™ä¸¦ç§»é™¤è¨˜æ†¶ã€‚"); 
    }
</script>
</body>
</html>