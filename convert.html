<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ç¹ç°¡ä¸­æ–‡å°ˆæ¥­è½‰æ›</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
<style>
  body { font-family: system-ui, -apple-system, sans-serif; background: #f4f6f8; margin: 0; padding: 20px; color: #333; }
  .container { max-width: 1200px; margin: auto; }
  
  h1 { text-align: center; color: #2c3e50; font-size: 2.2em; margin-bottom: 5px; }
  #status { text-align: center; color: #e67e22; font-weight: bold; min-height: 1.5em; margin-bottom: 15px; }

  /* ä¸Šæ–¹æ‹–æ”¾å€ */
  .drop-zone {
    border: 2px dashed #aaa; border-radius: 15px; padding: 40px;
    background: white; text-align: center; cursor: pointer;
    transition: 0.2s; color: #666; margin-bottom: 20px; line-height: 1.6;
  }
  .drop-zone.dragover { border-color: #3498db; background: #eaf4ff; }

  /* æŒ‰éˆ•åˆ—æ¨£å¼ (å°æ‡‰æˆªåœ–é¡è‰²) */
  .btn-group { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 25px; }
  button { padding: 10px 20px; border: none; border-radius: 6px; color: white; cursor: pointer; font-weight: 500; font-size: 15px; }
  
  .btn-select { background: #3498db; } /* è—è‰² */
  .btn-paste  { background: #8e44ad; } /* ç´«è‰² */
  .btn-copy   { background: #27ae60; } /* ç¶ è‰² */
  .btn-dl-tw  { background: #2c3e50; } /* æ·±ç°è‰² */
  .btn-dl-cn  { background: #2c3e50; } /* æ·±ç°è‰² */
  .btn-clear  { background: #e74c3c; } /* ç´…è‰² */
  button:hover { opacity: 0.9; }

  /* ä¸‹æ–¹é›™æ¬„çµæœå€ */
  .output-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .output-box { background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
  .output-box label { font-weight: bold; display: block; margin-bottom: 10px; color: #444; font-size: 1.1em; }
  
  textarea {
    width: 100%; height: 250px; padding: 12px; font-family: Consolas, monospace;
    font-size: 14px; border: 1px solid #eee; border-radius: 4px; box-sizing: border-box;
    background: #fdfdfd; resize: vertical; margin-bottom: 15px;
  }
  
  /* çµæœæ¡†å…§çš„ç¶ è‰²ä¸‹è¼‰æŒ‰éˆ• */
  .btn-dl-sub { background: #34c759; padding: 8px 18px; }
</style>
</head>
<body>

<div class="container">
  <h1>ç¹ç°¡ä¸­æ–‡å°ˆæ¥­è½‰æ›</h1>
  <div id="status">æº–å‚™å°±ç·’</div>

  <div class="drop-zone" id="dropZone">
    æ‹–æ”¾å¤šå€‹æ–‡å­—æª” (.txt / .md) åˆ°é€™è£¡<br>
    æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ (æ”¯æ´è‡ªå‹•è¾¨è­˜ç·¨ç¢¼èˆ‡å¤šæª”åˆä½µ)
    <input type="file" id="fileInput" multiple hidden>
  </div>

  <div class="btn-group">
    <button class="btn-select" onclick="fileInput.click()">é¸æ“‡æª”æ¡ˆ</button>
    <button class="btn-paste" onclick="pasteFromClipboard()">å¾å‰ªè²¼ç°¿è²¼ä¸Š</button>
    <button class="btn-copy" onclick="copyResult()">è¤‡è£½çµæœ</button>
    <button class="btn-dl-tw" onclick="downloadFile('tw')">â¬‡ ä¸‹è¼‰ç¹é«”æª”</button>
    <button class="btn-dl-cn" onclick="downloadFile('cn')">â¬‡ ä¸‹è¼‰ç°¡é«”æª”</button>
    <button class="btn-clear" onclick="clearAll()">æ¸…é™¤</button>
  </div>

  <textarea id="hiddenInput" style="display:none;"></textarea>

  <div class="output-grid">
    <div class="output-box">
      <label>ç¹é«”ä¸­æ–‡çµæœ (Traditional)</label>
      <textarea id="outputTW" placeholder="ç­‰å¾…è½‰æ›..."></textarea>
      <button class="btn-dl-sub" onclick="downloadFile('tw')">ä¸‹è¼‰ç¹é«”æª”</button>
    </div>
    <div class="output-box">
      <label>ç°¡é«”ä¸­æ–‡çµæœ (Simplified)</label>
      <textarea id="outputCN" placeholder="ç­‰å¾…è½‰æ›..."></textarea>
      <button class="btn-dl-sub" onclick="downloadFile('cn')">ä¸‹è¼‰ç°¡é«”æª”</button>
    </div>
  </div>
</div>

<script>
/* ---------- æ ¸å¿ƒè½‰æ›å¼•æ“ ---------- */
const toTW = OpenCC.Converter({ from: 'cn', to: 'twp' }); // å°ç£ç¹é«”æ…£ç”¨è©
const toCN = OpenCC.Converter({ from: 'tw', to: 'cn' });

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const hiddenInput = document.getElementById('hiddenInput');
const outputTW = document.getElementById('outputTW');
const outputCN = document.getElementById('outputCN');
const statusDiv = document.getElementById('status');

/* ---------- è‡ªå‹•è§£ç¢¼ (æ‚¨çš„å„ªåŒ–æ–¹æ¡ˆ) ---------- */
function autoDecode(arrayBuffer) {
  const encodings = ["utf-8", "gbk", "big5"];
  let bestText = "", bestEncoding = "utf-8", minInvalid = Infinity;
  for (let enc of encodings) {
    try {
      const decoder = new TextDecoder(enc, { fatal: true });
      const text = decoder.decode(arrayBuffer);
      const invalidCount = (text.match(/\ufffd/g) || []).length;
      if (invalidCount < minInvalid) { minInvalid = invalidCount; bestText = text; bestEncoding = enc; }
      if (invalidCount === 0) break;
    } catch (e) { continue; }
  }
  return { text: bestText, encoding: bestEncoding };
}

/* ---------- æª”æ¡ˆè®€å–èˆ‡åˆä½µ ---------- */
dropZone.onclick = () => fileInput.click();
fileInput.onchange = e => handleFiles(e.target.files);
dropZone.ondrop = e => { e.preventDefault(); handleFiles(e.dataTransfer.files); };
dropZone.ondragover = e => { e.preventDefault(); dropZone.classList.add('dragover'); };
dropZone.ondragleave = () => dropZone.classList.remove('dragover');

async function handleFiles(fileList) {
  if (!fileList.length) return;
  let combinedText = "";
  for (let file of fileList) {
    const buffer = await file.arrayBuffer();
    const result = autoDecode(buffer);
    combinedText += (combinedText ? "\n\n" : "") + result.text.trim();
  }
  hiddenInput.value = combinedText;
  processConversion();
  statusDiv.textContent = `âœ… å·²è¼‰å…¥ ${fileList.length} å€‹æª”æ¡ˆä¸¦å®Œæˆè½‰æ›`;
}

/* ---------- åŸ·è¡Œè½‰æ› ---------- */
function processConversion() {
  const val = hiddenInput.value;
  if (!val) return;
  outputTW.value = toTW(val);
  outputCN.value = toCN(val);
}

/* ---------- å·¥å…·æŒ‰éˆ• ---------- */
async function pasteFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    hiddenInput.value = text;
    processConversion();
    statusDiv.textContent = "ğŸ“‹ å·²è²¼ä¸Šå…§å®¹ä¸¦è½‰æ›";
  } catch (err) { statusDiv.textContent = "âŒ ç„¡æ³•è®€å–å‰ªè²¼ç°¿"; }
}

function downloadFile(type) {
  const content = (type === 'tw') ? outputTW.value : outputCN.value;
  if (!content || content === "ç­‰å¾…è½‰æ›...") return alert('æ²’æœ‰å…§å®¹å¯ä»¥ä¸‹è¼‰');
  const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `converted_${type}_${new Date().getTime()}.txt`;
  a.click();
}

function copyResult() {
  // é è¨­è¤‡è£½ç¹é«”çµæœ
  if (!outputTW.value) return;
  outputTW.select();
  document.execCommand('copy');
  statusDiv.textContent = "âœ¨ å·²è¤‡è£½ç¹é«”çµæœåˆ°å‰ªè²¼ç°¿";
}

function clearAll() {
  hiddenInput.value = "";
  outputTW.value = "";
  outputCN.value = "";
  fileInput.value = "";
  statusDiv.textContent = "å·²æ¸…é™¤";
}
</script>

</body>
</html>
