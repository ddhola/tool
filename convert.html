<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>繁簡轉換專業工具</title>
    <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jschardet/3.0.0/jschardet.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f5f5f7; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .section { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        textarea { width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 15px 0; }
        button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-convert { background-color: #007aff; color: white; }
        .btn-download { background-color: #34c759; color: white; }
        .btn-clear { background-color: #ff3b30; color: white; }
        input[type="file"] { border: 1px dashed #ccc; padding: 10px; width: 100%; box-sizing: border-box; }
        .output-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .output-box { background: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #ddd; }
        .label { font-weight: bold; margin-bottom: 8px; display: block; color: #555; }
        pre { white-space: pre-wrap; word-wrap: break-word; font-size: 14px; max-height: 300px; overflow-y: auto; background: #fff; padding: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>

<div class="container">
    <h1>繁簡轉換工具</h1>

    <div class="section">
        <span class="label">Step 1: 輸入文字 或 上傳檔案 (支援多檔合併)</span>
        <textarea id="inputText" placeholder="請在此貼上文字..."></textarea>
        <div class="controls">
            <input type="file" id="fileInput" multiple accept=".txt,.md,.csv">
        </div>
    </div>

    <div class="section">
        <span class="label">Step 2: 操作轉換</span>
        <div class="controls">
            <button class="btn-convert" onclick="processConversion()">執行轉換</button>
            <button class="btn-clear" onclick="clearAll()">清空全部</button>
        </div>
    </div>

    <div class="output-grid">
        <div class="output-box">
            <span class="label">繁體中文結果 (Traditional)</span>
            <pre id="twOutput">等待轉換...</pre>
            <button class="btn-download" onclick="downloadFile('tw')">下載繁體檔</button>
        </div>
        <div class="output-box">
            <span class="label">簡體中文結果 (Simplified)</span>
            <pre id="cnOutput">等待轉換...</pre>
            <button class="btn-download" onclick="downloadFile('cn')">下載簡體檔</button>
        </div>
    </div>
</div>

<script>
    // 初始化轉換器
    const toTw = OpenCC.Converter({ from: 'cn', to: 'tw' });
    const toCn = OpenCC.Converter({ from: 'tw', to: 'cn' });

    // 處理檔案上傳與自動偵測編碼
    document.getElementById('fileInput').addEventListener('change', async function(e) {
        const files = e.target.files;
        let combinedText = "";

        for (let file of files) {
            const buffer = await file.arrayBuffer();
            const uint8Array = new Uint8Array(buffer);
            
            // 使用 jschardet 偵測編碼
            const detected = jschardet.detect(uint8Array);
            const encoding = detected.encoding || 'UTF-8';
            
            const decoder = new TextDecoder(encoding);
            const text = decoder.decode(uint8Array);
            
            combinedText += (combinedText ? "\n\n--- 檔案分界線 ---\n\n" : "") + text;
        }
        
        document.getElementById('inputText').value = combinedText;
    });

    function processConversion() {
        const input = document.getElementById('inputText').value;
        if (!input) {
            alert("請先輸入文字或上傳檔案");
            return;
        }

        // 執行轉換
        const twText = toTw(input);
        const cnText = toCn(input);

        // 顯示結果
        document.getElementById('twOutput').textContent = twText;
        document.getElementById('cnOutput').textContent = cnText;
    }

    function downloadFile(type) {
        const content = document.getElementById(type === 'tw' ? 'twOutput' : 'cnOutput').textContent;
        if (content === "等待轉換...") {
            alert("請先執行轉換再下載");
            return;
        }

        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `converted_${type}_${new Date().getTime()}.txt`;
        link.click();
        URL.revokeObjectURL(url);
    }

    function clearAll() {
        document.getElementById('inputText').value = '';
        document.getElementById('twOutput').textContent = '等待轉換...';
        document.getElementById('cnOutput').textContent = '等待轉換...';
        document.getElementById('fileInput').value = '';
    }
</script>

</body>
</html>