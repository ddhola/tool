<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ç¹ç°¡ä¸­æ–‡è½‰æ›å·¥å…·</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>
<style>
  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 20px;
  }
  .container {
    max-width: 1000px;
    margin: auto;
  }
  h1 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 10px;
  }
  .drop-zone {
    border: 3px dashed #aaa;
    border-radius: 12px;
    padding: 40px;
    background: white;
    text-align: center;
    cursor: pointer;
    transition: 0.2s;
    color: #555;
    margin-bottom: 15px;
  }
  .drop-zone.dragover {
    border-color: #3498db;
    background: #eaf4ff;
  }
  #status {
    text-align: center;
    color: #e67e22;
    font-weight: bold;
    min-height: 1.5em;
    margin-bottom: 10px;
  }
  textarea {
    width: 100%;
    min-height: 240px;
    margin-top: 10px;
    padding: 12px;
    font-family: Consolas, monospace;
    font-size: 14px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  button {
    padding: 10px 18px;
    margin: 5px 4px 0 0;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-weight: 500;
  }
  .btn-main { background: #3498db; }
  .btn-paste { background: #8e44ad; }
  .btn-copy { background: #27ae60; }
  .btn-clear { background: #e74c3c; }
  .btn-main:hover { opacity: 0.9; }

  .info {
    text-align: center;
    color: #7f8c8d;
    margin-top: 20px;
    font-size: 0.9em;
    line-height: 1.6;
  }
</style>
</head>
<body>

<div class="container">
  <h1>ç¹ç°¡ä¸­æ–‡å°ˆæ¥­è½‰æ›</h1>
  
  <div id="status">æº–å‚™å°±ç·’</div>

  <div class="drop-zone" id="dropZone">
    æ‹–æ”¾å¤šå€‹æ–‡å­—æª” (.txt / .md) åˆ°é€™è£¡<br>
    æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ (æ”¯æ´è‡ªå‹•è¾¨è­˜ç·¨ç¢¼èˆ‡å¤šæª”åˆä½µ)
    <input type="file" id="fileInput" multiple hidden>
  </div>

  <div>
    <button class="btn-main" onclick="fileInput.click()">é¸æ“‡æª”æ¡ˆ</button>
    <button class="btn-paste" onclick="pasteFromClipboard()">å¾å‰ªè²¼ç°¿è²¼ä¸Š</button>
    <button class="btn-copy" onclick="copyResult()">è¤‡è£½çµæœ</button>
    <button class="btn-main" style="background: #2c3e50;" onclick="downloadFile('tw')">â¬‡ ä¸‹è¼‰ç¹é«”æª”</button>
    <button class="btn-main" style="background: #2c3e50;" onclick="downloadFile('cn')">â¬‡ ä¸‹è¼‰ç°¡é«”æª”</button>
    <button class="btn-clear" onclick="clearAll()">æ¸…é™¤</button>
  </div>

  <textarea id="input" placeholder="è®€å–çš„åŸå§‹å…§å®¹..."></textarea>
  <textarea id="output" placeholder="è½‰æ›çµæœå°‡é¡¯ç¤ºæ–¼æ­¤..."></textarea>

  <div class="info">
    è‡ªå‹•è¾¨è­˜ç·¨ç¢¼ (UTF-8 / GBK / Big5)ï½œæ”¯æ´å¤šæª”åˆä½µ<br>
    æ¡ç”¨ OpenCC è½‰æ›å¼•æ“ï¼šæ”¯æ´å°ç£æ…£ç”¨èªè½‰æ›
  </div>
</div>

<script>
// åˆå§‹åŒ– OpenCC è½‰æ›å™¨
const toTW = OpenCC.Converter({ from: 'cn', to: 'twp' }); // è½‰ç¹é«”(å«å°ç£ç”¨èª)
const toCN = OpenCC.Converter({ from: 'tw', to: 'cn' });  // è½‰ç°¡é«”

const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const input = document.getElementById('input');
const output = document.getElementById('output');
const statusDiv = document.getElementById('status');

/* ---------- æ ¸å¿ƒï¼šè‡ªå‹•è§£ç¢¼åŠŸèƒ½ (ä¿ç•™åŸæ–¹æ¡ˆ) ---------- */
function autoDecode(arrayBuffer) {
  const encodings = ["utf-8", "gbk", "big5"];
  let bestText = "";
  let bestEncoding = "utf-8";
  let minInvalid = Infinity;

  for (let enc of encodings) {
    try {
      const decoder = new TextDecoder(enc, { fatal: true });
      const text = decoder.decode(arrayBuffer);
      const invalidCount = (text.match(/\ufffd/g) || []).length;
      
      if (invalidCount < minInvalid) {
        minInvalid = invalidCount;
        bestText = text;
        bestEncoding = enc;
      }
      if (invalidCount === 0) break; 
    } catch (e) {
      continue;
    }
  }
  return { text: bestText, encoding: bestEncoding };
}

/* ---------- æ‹–æ”¾èˆ‡æª”æ¡ˆè™•ç† (ä¿ç•™åŸæ–¹æ¡ˆ) ---------- */
['dragenter','dragover'].forEach(e =>
  dropZone.addEventListener(e, ev => {
    ev.preventDefault();
    dropZone.classList.add('dragover');
  })
);
['dragleave','drop'].forEach(e =>
  dropZone.addEventListener(e, ev => {
    ev.preventDefault();
    dropZone.classList.remove('dragover');
  })
);

dropZone.onclick = () => fileInput.click();
dropZone.ondrop = e => handleFiles(e.dataTransfer.files);
fileInput.onchange = e => handleFiles(e.target.files);

function handleFiles(fileList) {
  if (!fileList || fileList.length === 0) return;
  const files = Array.from(fileList);
  input.value = '';
  let index = 0;

  function readNext() {
    if (index >= files.length) {
      statusDiv.textContent = `âœ… è®€å–å®Œæˆ (${files.length} å€‹æª”æ¡ˆ)ï¼Œæ­£åœ¨è½‰æ›...`;
      convert('tw'); // é è¨­å…ˆè½‰ç¹é«”é¡¯ç¤º
      return;
    }
    const file = files[index++];
    const reader = new FileReader();
    reader.onload = e => {
      const result = autoDecode(e.target.result);
      input.value += (input.value ? '\n' : '') + result.text.trim();
      statusDiv.textContent = `æ­£åœ¨è®€å– (${index}/${files.length}) - ç·¨ç¢¼: ${result.encoding.toUpperCase()}`;
      readNext();
    };
    reader.readAsArrayBuffer(file);
  }
  readNext();
}

/* ---------- è½‰æ›é‚è¼¯ (æ›¿æ›ç‚º OpenCC) ---------- */
function convert(targetType) {
  const text = input.value.trim();
  if (!text) return;
  
  if (targetType === 'tw') {
    output.value = toTW(text);
    statusDiv.textContent = "âœ… å·²å®Œæˆè½‰æ›ï¼šè‡³ç¹é«” (å°ç£æ…£ç”¨èª)";
  } else {
    output.value = toCN(text);
    statusDiv.textContent = "âœ… å·²å®Œæˆè½‰æ›ï¼šè‡³ç°¡é«”";
  }
}

/* ---------- å·¥å…·åŠŸèƒ½ ---------- */
async function pasteFromClipboard() {
  try {
    const text = await navigator.clipboard.readText();
    if (text.trim()) {
      input.value = text.trim();
      convert('tw'); 
      statusDiv.textContent = "ğŸ“‹ å·²è²¼ä¸Šä¸¦å®Œæˆç¹é«”è½‰æ›";
    }
  } catch (err) {
    statusDiv.textContent = "âŒ ç„¡æ³•è®€å–å‰ªè²¼ç°¿";
  }
}

function downloadFile(type) {
  const source = input.value.trim();
  if (!source) return alert('æ²’æœ‰å…§å®¹å¯ä»¥ä¸‹è¼‰');
  
  const result = type === 'tw' ? toTW(source) : toCN(source);
  const blob = new Blob([result], { type: 'text/plain;charset=utf-8;' });
  const a = document.createElement('a');
  const ts = new Date().getTime();
  a.href = URL.createObjectURL(blob);
  a.download = `converted_${type}_${ts}.txt`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function copyResult() {
  if (!output.value) return;
  output.select();
  document.execCommand('copy');
  statusDiv.textContent = "âœ¨ å·²è¤‡è£½çµæœåˆ°å‰ªè²¼ç°¿";
}

function clearAll() {
  input.value = '';
  output.value = '';
  fileInput.value = '';
  statusDiv.textContent = "å·²æ¸…é™¤æ‰€æœ‰å…§å®¹";
}

// ç›£è½è¼¸å…¥æ¡†è®Šå‹•å³æ™‚æ›´æ–°ï¼ˆå¯é¸ï¼‰
input.oninput = () => { if(input.value) convert('tw'); };
</script>

</body>
</html>
